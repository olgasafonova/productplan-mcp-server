name: API Drift Check

on:
  schedule:
    # Every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run API integration tests
        env:
          PRODUCTPLAN_API_TOKEN: ${{ secrets.PRODUCTPLAN_API_TOKEN }}
        run: go test -tags integration -run TestAPIEndpoints -v ./internal/api/

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'api-drift',
              state: 'open'
            });
            if (existing.data.length > 0) {
              console.log('Open api-drift issue already exists, skipping');
              return;
            }
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'API drift detected: ProductPlan endpoints changed',
              body: `The weekly API integration test failed, indicating that one or more ProductPlan API endpoints may have changed.\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nSteps:\n1. Check the failed test output for which endpoints returned unexpected status codes\n2. Verify against the [ProductPlan API docs](https://developer.productplan.com)\n3. Update \`internal/api/endpoints.go\` and \`testdata/api-endpoints.json\`\n4. Update tool definitions if field names changed`,
              labels: ['api-drift']
            });
