name: Publish to MCP Registry

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Wait for Docker image
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE="ghcr.io/olgasafonova/productplan-mcp-server:${VERSION}"
          echo "Waiting for Docker image: $IMAGE"

          for i in {1..30}; do
            if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
              echo "Docker image available!"
              exit 0
            fi
            echo "Attempt $i/30: Image not ready, waiting 30s..."
            sleep 30
          done

          echo "Error: Docker image not available after 15 minutes"
          exit 1

      - name: Wait for release binaries
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Waiting for release binaries..."

          for i in {1..20}; do
            COUNT=$(gh release view "v${VERSION}" --json assets --jq '.assets | length')
            if [ "$COUNT" -ge 5 ]; then
              echo "Release has $COUNT assets, ready!"
              exit 0
            fi
            echo "Attempt $i/20: Only $COUNT assets, waiting 15s..."
            sleep 15
          done

          echo "Error: Release binaries not ready after 5 minutes"
          exit 1

      - name: Download release assets and compute checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="olgasafonova/productplan-mcp-server"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          # Download each .mcpb file and compute SHA256
          for platform in darwin-arm64 darwin-amd64 linux-amd64 linux-arm64 windows-amd64; do
            FILE="productplan-mcp-server-${platform}.mcpb"
            URL="${BASE_URL}/${FILE}"
            echo "Downloading ${URL}..."
            curl -sL -o "${FILE}" "${URL}"
            CHECKSUM=$(sha256sum "${FILE}" | cut -d' ' -f1)
            echo "${platform}=${CHECKSUM}" >> checksums.txt
            echo "  ${platform}: ${CHECKSUM}"
          done

      - name: Build server.json with OCI and MCPB packages
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="olgasafonova/productplan-mcp-server"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          # Read checksums
          DARWIN_ARM64=$(grep "darwin-arm64=" checksums.txt | cut -d'=' -f2)
          DARWIN_AMD64=$(grep "darwin-amd64=" checksums.txt | cut -d'=' -f2)
          LINUX_AMD64=$(grep "linux-amd64=" checksums.txt | cut -d'=' -f2)
          LINUX_ARM64=$(grep "linux-arm64=" checksums.txt | cut -d'=' -f2)
          WINDOWS_AMD64=$(grep "windows-amd64=" checksums.txt | cut -d'=' -f2)

          # Build server.json with both OCI and MCPB packages
          cat > server.json << EOF
          {
            "\$schema": "https://static.modelcontextprotocol.io/schemas/2025-12-11/server.schema.json",
            "name": "io.github.olgasafonova/productplan-mcp-server",
            "title": "ProductPlan MCP Server",
            "description": "Talk to roadmaps with AI. Query and manage bars, OKRs, ideas, and launches.",
            "websiteUrl": "https://github.com/olgasafonova/productplan-mcp-server",
            "repository": {
              "url": "https://github.com/olgasafonova/productplan-mcp-server",
              "source": "github"
            },
            "version": "${VERSION}",
            "packages": [
              {
                "registryType": "oci",
                "identifier": "ghcr.io/olgasafonova/productplan-mcp-server:${VERSION}",
                "transport": {"type": "stdio"},
                "environmentVariables": [
                  {
                    "name": "PRODUCTPLAN_API_TOKEN",
                    "description": "Your ProductPlan API token from Settings → API",
                    "isRequired": true,
                    "isSecret": true
                  }
                ]
              },
              {
                "registryType": "mcpb",
                "identifier": "${BASE_URL}/productplan-mcp-server-darwin-arm64.mcpb",
                "version": "${VERSION}",
                "fileSha256": "${DARWIN_ARM64}",
                "transport": {"type": "stdio"},
                "environmentVariables": [
                  {
                    "name": "PRODUCTPLAN_API_TOKEN",
                    "description": "Your ProductPlan API token from Settings → API",
                    "isRequired": true,
                    "isSecret": true
                  }
                ]
              },
              {
                "registryType": "mcpb",
                "identifier": "${BASE_URL}/productplan-mcp-server-darwin-amd64.mcpb",
                "version": "${VERSION}",
                "fileSha256": "${DARWIN_AMD64}",
                "transport": {"type": "stdio"},
                "environmentVariables": [
                  {
                    "name": "PRODUCTPLAN_API_TOKEN",
                    "description": "Your ProductPlan API token from Settings → API",
                    "isRequired": true,
                    "isSecret": true
                  }
                ]
              },
              {
                "registryType": "mcpb",
                "identifier": "${BASE_URL}/productplan-mcp-server-linux-amd64.mcpb",
                "version": "${VERSION}",
                "fileSha256": "${LINUX_AMD64}",
                "transport": {"type": "stdio"},
                "environmentVariables": [
                  {
                    "name": "PRODUCTPLAN_API_TOKEN",
                    "description": "Your ProductPlan API token from Settings → API",
                    "isRequired": true,
                    "isSecret": true
                  }
                ]
              },
              {
                "registryType": "mcpb",
                "identifier": "${BASE_URL}/productplan-mcp-server-linux-arm64.mcpb",
                "version": "${VERSION}",
                "fileSha256": "${LINUX_ARM64}",
                "transport": {"type": "stdio"},
                "environmentVariables": [
                  {
                    "name": "PRODUCTPLAN_API_TOKEN",
                    "description": "Your ProductPlan API token from Settings → API",
                    "isRequired": true,
                    "isSecret": true
                  }
                ]
              },
              {
                "registryType": "mcpb",
                "identifier": "${BASE_URL}/productplan-mcp-server-windows-amd64.mcpb",
                "version": "${VERSION}",
                "fileSha256": "${WINDOWS_AMD64}",
                "transport": {"type": "stdio"},
                "environmentVariables": [
                  {
                    "name": "PRODUCTPLAN_API_TOKEN",
                    "description": "Your ProductPlan API token from Settings → API",
                    "isRequired": true,
                    "isSecret": true
                  }
                ]
              }
            ]
          }
          EOF
          cat server.json

      - name: Install mcp-publisher
        run: |
          curl -sL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          chmod +x mcp-publisher
          ./mcp-publisher --version

      - name: Authenticate with MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish
